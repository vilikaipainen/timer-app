<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Timer</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body, h1, button, .picker-item, .time-text {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      color: #333;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    body {
      background: #f5f5f5;
      text-align: center;
      margin: 0;
      padding-top: 10px;
      user-select: none;
    }

    h1 { margin-top: 10px; margin-bottom: 20px; }

    .timer-container {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 20px auto 10px auto;
    }

    svg {
      transform: rotate(-90deg);
      width: 220px; height: 220px;
    }

    circle.bg { fill: none; stroke: #e0e0e0; stroke-width: 12; }
    circle.progress { fill: none; stroke: #4caf50; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.3s linear; }

    .time-text {
      font-size: 32px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }

    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    #startBtn { background-color: #1976d2; color: white; }
    #pauseBtn { background-color: #fbc02d; color: black; }
    #resetBtn { background-color: #eee; }

    .picker-wrapper {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 25px;
    }

    .picker {
      position: relative;
      width: 70px;
      height: 150px;
      overflow: hidden;
      border-radius: 15px;
      background-color: #fff;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .picker-list {
      position: absolute;
      left: 0; right: 0; top: 0;
      text-align: center;
      transition: top 0.15s linear;
    }

    .picker-item {
      height: 40px; line-height: 40px;
      font-size: 28px;
    }

    .picker-item.selected { font-size: 38px; }

    .highlight-bar {
      position: absolute;
      top: 50%; left: 0; right: 0;
      height: 40px;
      border-top: 2px solid #4caf50;
      border-bottom: 2px solid #4caf50;
      transform: translateY(-50%);
      pointer-events: none;
    }
  </style>
</head>

<body>

<h1>Timer</h1>

<div class="timer-container">
  <svg>
    <circle class="bg" r="94" cx="110" cy="110"/>
    <circle class="progress" r="94" cx="110" cy="110" stroke-dasharray="591" stroke-dashoffset="0"/>
  </svg>
  <div class="time-text" id="timeText">00:01:00</div>
</div>

<h2 id="pointsDisplay">Points: 0</h2>

<div class="picker-wrapper">
  <div class="picker" id="hoursPicker"></div>
  <div class="picker" id="minutesPicker"></div>
</div>

<div>
  <button id="startBtn">Start</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="resetBtn">Reset</button>
</div>

<script>

// ─────────────────────────────────────────────
// ELEMENTIT
// ─────────────────────────────────────────────

const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");
const timeText = document.getElementById("timeText");
const circleProgress = document.querySelector("circle.progress");

// ─────────────────────────────────────────────
// PISTELOGIIKKA
// ─────────────────────────────────────────────

function updatePointsDisplay() {
    const points = Number(localStorage.getItem("points") || 0);
    document.getElementById("pointsDisplay").textContent = "Points: " + points;
}

function calculatePoints(seconds) {
    return Math.floor(seconds / 60) * 5;
}

function awardPoints(totalSeconds) {
    const earned = calculatePoints(totalSeconds);
    const before = Number(localStorage.getItem("points") || 0);
    const updated = before + earned;
    localStorage.setItem("points", updated);
    updatePointsDisplay();
}

// ─────────────────────────────────────────────
// TIMER-VARIABLET
// ─────────────────────────────────────────────

let selectedHour = 0;
let selectedMinute = 1;

let totalTime = selectedHour * 3600 + selectedMinute * 60;
let timerEnd = null;
let timerInterval = null;
let ticking = false;
let isPaused = false;

const radius = 94;
const circumference = 2 * Math.PI * radius;

// ─────────────────────────────────────────────
// FUNKTIOT
// ─────────────────────────────────────────────

function formatTime(seconds) {
    seconds = Math.max(0, seconds);
    const h = String(Math.floor(seconds / 3600)).padStart(2, "0");
    const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    return `${h}:${m}:${s}`;
}

function updateUI() {
    let remaining = timerEnd
        ? Math.max(0, Math.floor((timerEnd - Date.now()) / 1000))
        : totalTime;

    timeText.textContent = formatTime(remaining);

    const ratio = remaining / totalTime;
    circleProgress.style.strokeDashoffset = circumference * (1 - ratio);
}

function tick() {
    updateUI();
    if (Math.floor((timerEnd - Date.now()) / 1000) <= 0) {
        stopTimer(true);
    }
}

// ─────────────────────────────────────────────
// START
// ─────────────────────────────────────────────

function startTimer() {
    if (ticking) return;

    ticking = true;
    isPaused = false;

    timerEnd = Date.now() + totalTime * 1000;

    localStorage.setItem("timerEnd", timerEnd);
    localStorage.setItem("timerTotal", totalTime);

    pauseBtn.disabled = false;
    pauseBtn.textContent = "Pause";

    timerInterval = setInterval(tick, 250);
}

// ─────────────────────────────────────────────
// PAUSE
// ─────────────────────────────────────────────

function togglePause() {
    if (!ticking && !isPaused) return;

    if (!isPaused) {
        clearInterval(timerInterval);

        const remaining = Math.max(0, Math.floor((timerEnd - Date.now()) / 1000));
        totalTime = remaining;

        ticking = false;
        isPaused = true;

        pauseBtn.textContent = "Continue";
    } else {
        ticking = true;
        isPaused = false;

        timerEnd = Date.now() + totalTime * 1000;
        localStorage.setItem("timerEnd", timerEnd);

        pauseBtn.textContent = "Pause";

        timerInterval = setInterval(tick, 250);
    }
}

// ─────────────────────────────────────────────
// STOP / AWARD
// ─────────────────────────────────────────────

function stopTimer(award = false) {
    ticking = false;
    isPaused = false;
    clearInterval(timerInterval);

    if (award) {
        const original = Number(localStorage.getItem("timerTotal") || totalTime);
        awardPoints(original);
    }

    pauseBtn.disabled = true;
    pauseBtn.textContent = "Pause";

    timerEnd = null;
    localStorage.removeItem("timerEnd");
}

// ─────────────────────────────────────────────
// RESET
// ─────────────────────────────────────────────

function resetTimer() {
    clearInterval(timerInterval);
    ticking = false;
    isPaused = false;

    selectedHour = 0;
    selectedMinute = 1;
    totalTime = selectedHour * 3600 + selectedMinute * 60;

    localStorage.removeItem("timerEnd");
    localStorage.removeItem("timerTotal");

    updatePicker(hoursPicker, selectedHour);
    updatePicker(minutesPicker, selectedMinute);

    circleProgress.style.strokeDashoffset = 0;
    timeText.textContent = formatTime(totalTime);

    pauseBtn.disabled = true;
    pauseBtn.textContent = "Pause";
}

// ─────────────────────────────────────────────
// NAPPITAPAHTUMAT — TÄMÄ OLI SE PUUTTUVA KOHTA!
// ─────────────────────────────────────────────

startBtn.addEventListener("click", startTimer);
pauseBtn.addEventListener("click", togglePause);
resetBtn.addEventListener("click", resetTimer);

// ─────────────────────────────────────────────
// LATAA KESKEN OLEVA AJASTIN
// ─────────────────────────────────────────────

window.addEventListener("load", () => {
    updatePointsDisplay();

    const savedEnd = Number(localStorage.getItem("timerEnd"));
    const savedTotal = Number(localStorage.getItem("timerTotal"));

    if (savedEnd && Date.now() < savedEnd) {
        totalTime = savedTotal;
        timerEnd = savedEnd;
        ticking = true;
        timerInterval = setInterval(tick, 250);
        pauseBtn.disabled = false;
    }

    updateUI();
});

// ─────────────────────────────────────────────
// PICKERIT
// ─────────────────────────────────────────────

const hoursPicker = document.getElementById("hoursPicker");
const minutesPicker = document.getElementById("minutesPicker");

function buildPicker(picker, range) {
    picker.innerHTML = "";
    const list = document.createElement("div");
    list.className = "picker-list";
    picker.appendChild(list);

    for (let i = 0; i < range; i++) {
        const item = document.createElement("div");
        item.className = "picker-item";
        item.textContent = i.toString().padStart(2, "0");
        list.appendChild(item);
    }

    const highlight = document.createElement("div");
    highlight.className = "highlight-bar";
    picker.appendChild(highlight);
}

function updatePicker(picker, index) {
    const list = picker.querySelector(".picker-list");
    const center = picker.offsetHeight / 2 - 20;
    list.style.top = center - index * 40 + "px";

    picker.querySelectorAll(".picker-item").forEach((item, i) => {
        item.classList.toggle("selected", i === index);
    });
}

function addPickerDrag(picker, maxRange, setValue) {
    let dragging = false,
        startY = 0,
        startTop = 0;

    const list = picker.querySelector(".picker-list");

    function move(y) {
        let delta = y - startY;
        let newTop = startTop + delta;

        const maxTop = picker.offsetHeight / 2 - 20;
        const minTop = -(maxRange - 1) * 40 + picker.offsetHeight / 2 - 20;

        if (newTop > maxTop) newTop = maxTop;
        if (newTop < minTop) newTop = minTop;

        list.style.top = newTop + "px";

        let index = Math.round((picker.offsetHeight / 2 - 20 - newTop) / 40);
        index = Math.max(0, Math.min(maxRange - 1, index));

        setValue(index);
        updatePicker(picker, index);

        totalTime = selectedHour * 3600 + selectedMinute * 60;
        updateUI();
    }

    function down(e) {
        dragging = true;
        startY = e.clientY || e.touches[0].clientY;
        startTop = parseFloat(list.style.top) || 0;
        e.preventDefault();
    }

    function moveEvent(e) {
        if (dragging) move(e.clientY || e.touches[0].clientY);
    }

    function up() {
        dragging = false;
    }

    picker.addEventListener("mousedown", down);
    picker.addEventListener("touchstart", down, { passive: false });
    window.addEventListener("mousemove", moveEvent);
    window.addEventListener("touchmove", moveEvent, { passive: false });
    window.addEventListener("mouseup", up);
    window.addEventListener("touchend", up);
}

// Luo pickerit
buildPicker(hoursPicker, 13);
buildPicker(minutesPicker, 60);

updatePicker(hoursPicker, selectedHour);
updatePicker(minutesPicker, selectedMinute);

addPickerDrag(hoursPicker, 13, (i) => (selectedHour = i));
addPickerDrag(minutesPicker, 60, (i) => (selectedMinute = i));

updateUI();

</script>

</body>
</html>
